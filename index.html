<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="by" class="mixpanel-platform-label" style="margin-left: 10px; display: none;">by</div>
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
      <div id="graph"></div>
    </div>
    <div id="table"></div>
    <script>
      var save;
      var dateSelect  = $('#dateSelect').MPDatepicker();
      var eventGraph  = $('#graph').MPChart({chartType: 'line'});
      var eventTable  = $('#table').MPTable({
        showPercentages: true,
        firstColHeader: 'Event'
      });
 
      var runQuery = function() {
        var dateRange = dateSelect.MPDatepicker('value');
        var params = {
          type:'unique'
        };
        if (dateRange) {
          MP.api.segment('Game Played', dateRange).done(function(dividend) {
            MP.api.segment('App Open', dateRange).done(function(divisor) {
              
              var data = {};
              // Set our divisor dates and report them backgrounds
              var properties = _.keys(divisor.values())
              var divisorDates = _.keys(divisor.values()[properties[0]]).sort().reverse()
               /* Iterate through each divisor date to check whether it is greater
                  than the dividend. If so divide and store that data on the dividend
                  date. We loop backwards through the divisor to only divide dates
                  that are after our definition of a week
               */
              var divData = dividend.values()
              _.each(events, function(event) {
                data[event] = {}
                console.log(data);
                _.each(divisorDates, function(divisorDate) {
                  _.each(_.keys(divData[event]), function(divDate){
                    if (divDate <= divisorDate) {
                      denominator =  divisor.values()[event][divisorDate];
                      numerator = dividend.values()[event][divDate];
                      // Check for dividing by 0, in which case we do not include
                      if (denominator != 0) {
                        data[prop][divDate] =  numerator / denominator;
                      }
                    }
                  });
                });
              });
              console.log (data)
              debugger;
              
              eventGraph.MPChart('setData', data);
              eventTable.MPTable('setData', data);
            });
          });
        }
      };
      dateSelect.on('change', function(e, eventName) {
        runQuery();
      });
    </script>
  </body>
</html>
 